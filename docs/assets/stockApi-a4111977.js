localStorage.getItem("alphaVantageKey");const u=o=>{if(!o)return"";let e=String(o).toUpperCase().trim();return e=e.replace(/\s+/g,""),e=e.replace(/(?:\.|-|:|\/)?US$/,""),e},i="https://www.alphavantage.co/query",h=async(o,e)=>{var r;try{const t=await(await fetch(`${i}?function=SYMBOL_SEARCH&keywords=${encodeURIComponent(o)}&apikey=${e}`)).json(),a=(t==null?void 0:t.bestMatches)||[];if(!Array.isArray(a)||a.length===0)return null;const n=a.find(l=>/United States/i.test(l["4. region"])||/USD/i.test(l["8. currency"]));return(n==null?void 0:n["1. symbol"])||((r=a[0])==null?void 0:r["1. symbol"])||null}catch(s){return console.warn("symbol search failed:",s),null}},p=async o=>{try{const e=localStorage.getItem("alphaVantageKey")||"demo",r=u(o);if(e==="demo"&&r!=="IBM")return{success:!0,price:Math.random()*200+50,change:(Math.random()-.5)*10,changePercent:`${(Math.random()-.5)*5}%`,mock:!0,reason:"demo_key"};const t=await(await fetch(`${i}?function=GLOBAL_QUOTE&symbol=${r}&apikey=${e}`)).json();if(t["Global Quote"]&&t["Global Quote"]["05. price"])return{success:!0,price:parseFloat(t["Global Quote"]["05. price"]),change:parseFloat(t["Global Quote"]["09. change"]),changePercent:t["Global Quote"]["10. change percent"]};const a=await h(r,e);if(a&&a!==r){const c=await(await fetch(`${i}?function=GLOBAL_QUOTE&symbol=${a}&apikey=${e}`)).json();if(c["Global Quote"]&&c["Global Quote"]["05. price"])return{success:!0,price:parseFloat(c["Global Quote"]["05. price"]),change:parseFloat(c["Global Quote"]["09. change"]),changePercent:c["Global Quote"]["10. change percent"],resolvedSymbol:a}}const n=t!=null&&t.Note?"rate_limit":"no_price";return{success:!0,price:Math.random()*200+50,change:(Math.random()-.5)*10,changePercent:`${(Math.random()-.5)*5}%`,mock:!0,reason:n}}catch(e){return console.error("Error fetching stock quote:",e),{success:!0,price:Math.random()*200+50,change:(Math.random()-.5)*10,changePercent:`${(Math.random()-.5)*5}%`,mock:!0,reason:"fetch_error"}}},g=o=>{localStorage.setItem("alphaVantageKey",o)},m=()=>localStorage.getItem("alphaVantageKey");export{p as a,m as g,g as s};
